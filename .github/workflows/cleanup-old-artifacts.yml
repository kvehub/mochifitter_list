name: Cleanup old artifacts

on:
  workflow_dispatch:

jobs:
  cleanup:
    runs-on: ubuntu-latest
    permissions:
      actions: write
    steps:
      - name: Delete old artifacts
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;

            // Get artifacts (max 100 per page)
            const { data: { artifacts } } = await github.rest.actions.listArtifactsForRepo({
              owner,
              repo,
              per_page: 100
            });

            console.log(`Found ${artifacts.length} artifacts`);

            if (artifacts.length === 0) {
              console.log('No artifacts to delete');
              return;
            }

            let deleted = 0;
            for (const artifact of artifacts) {
              console.log(`Deleting: ${artifact.name} (ID: ${artifact.id}, Created: ${artifact.created_at})`);
              await github.rest.actions.deleteArtifact({
                owner,
                repo,
                artifact_id: artifact.id
              });
              deleted++;
            }

            console.log(`Deleted ${deleted} artifacts`);
